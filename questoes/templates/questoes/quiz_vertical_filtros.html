{% extends 'questoes/base.html' %}
{% load static %}

{% block title %}Quiz: {{ assunto.nome }} - Resumo Acad√™mico{% endblock %}

{% block breadcrumb %}
<!-- Breadcrumb Navigation -->
<div class="breadcrumb">
    <div class="header-container">
        <nav class="breadcrumb-nav">
            <a href="{% url 'questoes:index' %}" class="breadcrumb-link">üè† In√≠cio</a>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <a href="{% url 'questoes:escolher_assunto' %}" class="breadcrumb-link">üìö Conte√∫dos</a>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <a href="{% url 'questoes:listar_questoes' assunto.pk %}" class="breadcrumb-link">üìã Lista de Quest√µes</a>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <span class="breadcrumb-current">üéØ Quiz</span>
        </nav>
    </div>
</div>
{% endblock %}

{% block page_header %}
<!-- Page Title Section -->
<div class="page-header">
    <div class="header-container">
        <h1 class="page-title">Quiz: {{ assunto.nome }}</h1>
        <p class="page-subtitle">Sistema de Quest√µes com Filtros Din√¢micos</p>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    body { background-image: linear-gradient(to top, #00C6FF, #0072FF); min-height: 100vh; margin: 0; }
    .main-container { max-width: 1100px; margin: 0 auto; background: #fff; border-radius: 16px; border: 1px solid transparent; background-image: linear-gradient(#fff,#fff), linear-gradient(to top,#00C6FF,#0072FF); background-origin: border-box; background-clip: padding-box, border-box; box-shadow: 0 20px 40px rgba(0,0,0,.1); padding: 0 20px 24px 20px; }
</style>
{% endblock %}

{% block content %}
<div class="quiz-vertical-container">
    <!-- Progresso + meta -->
    <div class="progress-section">
        <div class="progress-meta">
            <div class="meta-left">
                <span class="meta-title"><i class="fas fa-layer-group"></i> Filtro:</span>
                <span class="meta-chip">
                    {% if filtro_ativo == 'todas' %}Todas{% elif filtro_ativo == 'respondidas' %}Respondidas{% elif filtro_ativo == 'nao-respondidas' %}N√£o Respondidas{% elif filtro_ativo == 'certas' %}Certas{% elif filtro_ativo == 'erradas' %}Erradas{% else %}{{ filtro_ativo|title }}{% endif %}
                </span>
                <span class="meta-sep">‚Ä¢</span>
                <span class="meta-title"><i class="fas fa-hashtag"></i> Total:</span>
                <span class="meta-chip total-questoes">{{ total_questoes }}</span>
            </div>
            <!-- Dropdown de filtro removido a pedido -->
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div>
        <p class="progress-text">Progresso</p>
    </div>

    <!-- Lista de quest√µes -->
    <div class="questions-vertical-container" id="questions-container"></div>

    <!-- Navega√ß√£o -->
    <div class="navigation">
        <button class="btn-nav btn-anterior" id="btn-anterior" onclick="questaoAnterior()" disabled><i class="fas fa-arrow-left"></i> Anterior</button>
        <button class="btn-nav btn-proximo" id="btn-proximo" onclick="proximaQuestao()">Pr√≥ximo <i class="fas fa-arrow-right"></i></button>
    </div>

    <div class="back-controls">
        <a href="{% url 'questoes:listar_questoes' assunto.pk %}" class="btn-voltar"><i class="fas fa-list"></i> Voltar √† Lista</a>
    </div>
</div>

<script>
    const questoesData = JSON.parse('{{ questoes|escapejs }}');
    const assuntoId = {{ assunto.pk }};
    const filtroAtivo = '{{ filtro_ativo|escapejs }}';
    const questaoInicial = {{ questao_inicial }};
    const userAuthenticated = {{ user_authenticated|yesno:"true,false" }};
    const csrfToken = '{{ csrf_token|escapejs }}';
    
</script>

{% csrf_token %}

<style>
/* ===== Layout ===== */
.quiz-vertical-container { max-width: 960px; margin: 0 auto; padding: 16px 4px 0 4px; }
.progress-section { background: #f8fafc; padding: 14px 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.06); margin: 16px 0 20px 0; }
.progress-meta { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:10px; }
.meta-left { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.meta-title { color:#475569; font-weight:700; font-size:.95rem; }
.meta-chip { padding:4px 10px; border-radius:999px; background:#eef2ff; color:#1e3a8a; font-weight:700; font-size:.9rem; }
.meta-sep { color:#94a3b8; }
.progress-bar { width:100%; height:8px; background:#e9ecef; border-radius:999px; overflow:hidden; }
.progress-fill { height:100%; background:linear-gradient(90deg,#00C6FF,#0072FF); transition:width .3s ease; }
.progress-text { margin:8px 0 0 0; text-align:center; font-weight:700; color:#475569; }

/* ===== Card de quest√£o ===== */
.question-card { background:#fff; border:1px solid #e2e8f0; border-radius:14px; box-shadow:0 6px 18px rgba(2,6,23,.06); overflow:hidden; transition:transform .2s ease, box-shadow .2s ease; }
.question-card:not(:first-child) { margin-top:16px; }
.question-card:hover { transform:translateY(-3px); box-shadow:0 10px 26px rgba(2,6,23,.1); }
.question-header { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px 14px; background:linear-gradient(135deg,#00C6FF 0%,#0072FF 100%); color:#fff; }
.question-number { font-weight:800; letter-spacing:.2px; font-size:1rem; }
.question-status { background:rgba(255,255,255,.18); padding:6px 10px; border-radius:999px; font-weight:800; font-size:.8rem; }
.question-status.certa{ background:linear-gradient(135deg,#1db954,#17b77a); color:#ffffff; box-shadow:0 2px 10px rgba(23,183,122,.25); border:1px solid rgba(23,183,122,.35); }
.question-status.errada{ background:linear-gradient(135deg,#e63946,#ff6b6b); color:#ffffff; box-shadow:0 2px 10px rgba(230,57,70,.25); border:1px solid rgba(230,57,70,.35); }
.question-status.nao-respondida{ background:linear-gradient(135deg,#ffd166,#fdbb2d); color:#7a4b00; box-shadow:0 2px 10px rgba(253,187,45,.25); border:1px solid rgba(253,187,45,.4); }
.question-status.respondida{ background:linear-gradient(135deg,#4dabf7,#228be6); color:#ffffff; box-shadow:0 2px 10px rgba(34,139,230,.25); border:1px solid rgba(34,139,230,.35); }
.question-text { padding:16px 14px; font-size:1rem; line-height:1.6; color:#0f172a; }

/* ===== Alternativas ===== */
.alternatives { padding: 0 14px 14px 14px; display:flex; flex-direction:column; gap:10px; user-select:none; }
.alternative-item { display:flex; align-items:flex-start; gap:12px; border:1.5px solid #e2e8f0; border-radius:12px; padding:12px 14px; background:#fff; cursor:pointer; pointer-events:auto; transition:border-color .2s ease, background .2s ease, transform .2s ease; }
.alternative-item:hover { border-color:#cfe2ff; background:#f8fbff; transform:translateX(3px); }
.alternative-item:focus { outline:3px solid rgba(0,114,255,.2); }
.alternative-letter { width:32px; height:32px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; background:linear-gradient(135deg,#0072FF 0%,#00C6FF 100%); box-shadow:0 2px 8px rgba(0,114,255,.2); flex-shrink:0; }
.alternative-text { color:#111827; font-weight:600; }
.alternative-item.resposta-correta { background:linear-gradient(135deg,#28a745 0%, #20c997 100%) !important; border-color:#28a745 !important; color:#fff !important; }
.alternative-item.incorreta { background:linear-gradient(135deg,#dc3545 0%, #e74c3c 100%) !important; border-color:#dc3545 !important; color:#fff !important; }

/* Navega√ß√£o */
.navigation { display:flex; gap:12px; margin:18px 0; }
.btn-nav { flex:1; padding:12px 16px; border:none; border-radius:10px; font-weight:800; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:transform .2s ease, box-shadow .2s ease; }
.btn-anterior { background:#64748b; }
.btn-proximo { background:#22c55e; }
.btn-nav:hover { transform:translateY(-2px); box-shadow:0 10px 22px rgba(2,6,23,.12); }

.back-controls { text-align:center; }
.btn-voltar { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; background:#6c757d; color:#fff; text-decoration:none; font-weight:800; }
.btn-voltar:hover { background:#5a6268; }

.sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
.fav-btn{ margin-left:8px; background:#ffffff22; border:1px solid rgba(255,255,255,.4); color:#fff; font-weight:900; border-radius:999px; width:34px; height:28px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; transition:transform .2s ease, background .2s ease; }
.fav-btn:hover{ transform:translateY(-1px); background:#ffffff33; }
.fav-btn.is-fav{ background:#ff3860; border-color:#ff3860; color:#fff; box-shadow:0 0 0 3px rgba(255,56,96,.25); }
.question-header-right{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
.question-header-right .fav-btn{ margin-left:0; background:#ffffff22; border:1px solid rgba(255,255,255,.4); color:#fff; font-weight:900; border-radius:999px; width:34px; height:28px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; transition:transform .2s ease, background .2s ease; }
.question-header-right .fav-btn:hover{ transform:translateY(-1px); background:#ffffff33; }
.question-header-right .fav-btn.is-fav{ background:#ff3860; border-color:#ff3860; color:#fff; box-shadow:0 0 0 3px rgba(255,56,96,.25); }
/* remove posicionamento absoluto para evitar sobreposi√ß√£o */
.question-header-right .question-status{ position:static; right:auto; top:auto; }
</style>

<script>
let questoesList = []; let respostas = {};

document.addEventListener('DOMContentLoaded', function(){
  try {
    questoesList = JSON.parse('{{ questoes|escapejs }}');
  } catch (e) {
    console.error('Falha ao parsear questoes JSON:', e);
    questoesList = [];
  }
  if(!questoesList || !questoesList.length){ mostrarMensagemVazia(); return; }
  renderizarTodasQuestoes(); atualizarProgresso(); inicializarFiltros();
});

function renderizarTodasQuestoes(){ const c=document.getElementById('questions-container'); c.innerHTML=''; questoesList.forEach((q,i)=>c.appendChild(criarCardQuestao(q,i))); }

function criarCardQuestao(questaoData,index){
  const card=document.createElement('div'); card.className='question-card';
  card.dataset.questaoId=questaoData.questao.id; card.dataset.questaoIndex=index; card.dataset.statusResposta=questaoData.status;
  card.innerHTML=`
    <div class=\"question-header\">\n      <span class=\"question-number\">Quest√£o ${index+1} de ${questoesList.length} (ID: ${questaoData.questao.id})</span>\n      <div class=\"question-header-right\">\n        <span class=\"question-status ${questaoData.status}\">${formatarStatus(questaoData.status)}</span>\n        <button class=\"fav-btn\" aria-label=\"Favoritar\" title=\"Favoritar\" data-questao-id=\"${questaoData.questao.id}\" onclick=\"toggleFavorito(${questaoData.questao.id}, this)\">‚ù§</button>\n      </div>\n    </div>\n    <div class=\"question-text\">${questaoData.questao.texto}</div>\n    <div class=\"alternatives\">\n      ${questaoData.alternativas.map(alt=>`\n        <div class=\"alternative-item\" role=\"button\" tabindex=\"0\" data-alternativa-id=\"${alt.id}\" onclick=\"responderQuestao(${questaoData.questao.id}, ${alt.id}, this)\">\n          <div class=\"alternative-letter\">${alt.letra}</div>\n          <div class=\"alternative-text\">${alt.texto}</div>\n        </div>`).join('')}\n    </div>`; return card; }

function formatarStatus(s){ const m={'nao-respondida':'N√£o Respondida','respondida':'Respondida','certa':'Certa','errada':'Errada'}; return m[s]||s; }

function responderQuestao(questaoId,alternativaId,elemento){
  const card=elemento.closest('.question-card'); const alternativas=card.querySelectorAll('.alternative-item');
  alternativas.forEach(alt=>{ alt.classList.remove('resposta-correta','incorreta'); alt.style.pointerEvents='none'; alt.style.cursor='default'; alt.style.background=''; alt.style.borderColor=''; alt.style.color=''; });
  const dados=questoesList.find(q=>q.questao.id===questaoId); const correta=dados?dados.alternativas.find(a=>a.eh_correta):null; if(!correta) return;
  const corretaId=Number(correta.id); const selId=Number(alternativaId);
  // registra resposta p/ progresso
  respostas[questaoId] = selId;
  alternativas.forEach(alt=>{ const id=Number(alt.dataset.alternativaId);
    if(id===corretaId && id===selId){ alt.classList.add('resposta-correta'); alt.style.background='linear-gradient(135deg,#28a745 0%, #20c997 100%)'; alt.style.borderColor='#28a745'; alt.style.color='#fff'; }
    else if(id===corretaId){ alt.classList.add('resposta-correta'); alt.style.background='linear-gradient(135deg,#28a745 0%, #20c997 100%)'; alt.style.borderColor='#28a745'; alt.style.color='#fff'; }
    else if(id===selId){ alt.classList.add('incorreta'); alt.style.background='linear-gradient(135deg,#dc3545 0%, #e74c3c 100%)'; alt.style.borderColor='#dc3545'; alt.style.color='#fff'; }
  });
  const idx=questoesList.findIndex(q=>q.questao.id===questaoId); if(idx>-1){ const ok=selId===corretaId; questoesList[idx].status=ok?'certa':'errada'; card.dataset.statusResposta=ok?'certa':'errada'; const st=card.querySelector('.question-status'); if(st){ st.textContent=ok?'CERTA':'ERRADA'; st.className=`question-status ${ok?'certa':'errada'}`; } }
  atualizarProgresso();
  const token=document.querySelector('[name=csrfmiddlewaretoken]').value; fetch('/questoes/quiz/validar/',{method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':token}, body:JSON.stringify({id_questao:questaoId,id_alternativa:selId})}).catch(()=>{});
}

function atualizarProgresso(){ const total=questoesList.length; const ans=Object.keys(respostas).length; const pct=Math.round((ans/total)*100); const pf=document.querySelector('.progress-fill'); const pt=document.querySelector('.progress-text'); if(pf) pf.style.width=`${pct}%`; if(pt) pt.textContent=`Progresso: ${ans}/${total} (${pct}%)`; }
function inicializarFiltros(){ /* somente contadores j√° tratados em outra tela; nada aqui */ }
function mostrarMensagemVazia(){ const c=document.querySelector('.quiz-vertical-container'); c.innerHTML='<div class="empty-state"><h2>Nenhuma quest√£o encontrada</h2><a class="btn-voltar" href="{% url 'questoes:listar_questoes' assunto.pk %}">Voltar</a></div>'; }

// Favoritos via localStorage
function getFavKey(){ return 'rq_favoritos'; }
function getFavoritos(){ try{ return new Set(JSON.parse(localStorage.getItem(getFavKey())||'[]')); }catch(e){ return new Set(); } }
function saveFavoritos(set){ localStorage.setItem(getFavKey(), JSON.stringify(Array.from(set))); }
function isFavorito(id){ const favs=getFavoritos(); return favs.has(Number(id)); }
function toggleFavorito(id, btn){ const favs=getFavoritos(); id=Number(id); if(favs.has(id)){ favs.delete(id); } else { favs.add(id); } saveFavoritos(favs); if(btn){ btn.classList.toggle('is-fav', favs.has(id)); } // marca no header
  // marca no card para poss√≠veis filtros futuros
  const card = btn ? btn.closest('.question-card') : document.querySelector(`.question-card[data-questao-id='${id}']`);
  if(card){ if(favs.has(id)) card.setAttribute('data-favorito','1'); else card.removeAttribute('data-favorito'); }
}

// Ap√≥s renderiza√ß√£o, aplicar estado do favorito
function aplicarFavoritosNosCards(){ const favs=getFavoritos(); document.querySelectorAll('.fav-btn').forEach(btn=>{ const id=Number(btn.dataset.questaoId); btn.classList.toggle('is-fav', favs.has(id)); const card=btn.closest('.question-card'); if(card){ if(favs.has(id)) card.setAttribute('data-favorito','1'); else card.removeAttribute('data-favorito'); } }); }

// Ajusta chamadas existentes
const _renderizarTodas = renderizarTodasQuestoes; renderizarTodasQuestoes = function(){ _renderizarTodas(); setTimeout(aplicarFavoritosNosCards, 0); };
</script>
{% endblock %}


{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema de Quest√µes - Resumo Acad√™mico{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" href="/media/fotos/Logotipo_resumo_academico.png" type="image/png">
    <link rel="apple-touch-icon" href="/media/fotos/minha-logo-apple.png">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/modern-style-complete.css' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="main-container">
        <!-- Header Moderno -->
        <header class="header">
            <div class="header-container header-topbar">
                <!-- Logo Section -->
                <div class="logo-section">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="brand-info">
                        <a href="{% url 'questoes:index' %}" class="brand-title">Resumo Acad√™mico</a>
                        <div class="brand-subtitle">Terapia Ocupacional</div>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="header-nav">
                    <a href="{% url 'questoes:index' %}" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>In√≠cio</span>
                    </a>
                    <a href="{% url 'questoes:escolher_assunto' %}" class="nav-link">
                        <i class="fas fa-book"></i>
                        <span>Conte√∫dos</span>
                    </a>
                    {% if user.is_authenticated %}
                    <a href="{% url 'questoes:desempenho' %}" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        <span>Desempenho</span>
                    </a>
                    {% endif %}
                </nav>

                <!-- User Info Section -->
                <div class="user-info">
                    {% if user.is_authenticated %}
                        <div class="user-profile">
                            <div class="user-avatar">
                                {{ user.first_name|default:user.username|first|upper }}
                            </div>
                            <span class="user-name">
                                {{ user.first_name|default:user.username }}{% if user.is_staff %} Admin{% endif %}
                            </span>
                        </div>
                        <a href="{% url 'questoes:logout' %}" class="header-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sair</span>
                        </a>
                    {% else %}
                        <a href="{% url 'questoes:login' %}" class="header-btn primary">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Entrar</span>
                        </a>
                    {% endif %}
                </div>
            </div>
        </header>
        
        <!-- Breadcrumb Navigation -->
        {% if not user.is_authenticated or request.resolver_match.url_name == 'index' %}
        <div class="breadcrumb">
            <div class="header-container">
                <nav class="breadcrumb-nav">
                    <span class="breadcrumb-current">
                        üè† In√≠cio
                    </span>
                </nav>
            </div>
        </div>
        {% else %}
        {% block breadcrumb %}{% endblock %}
        {% endif %}
        
        <!-- Page Title Section (se definido nos templates filhos) -->
        {% block page_header %}{% endblock %}
        
        <!-- Mensagens do Django -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}" style="margin-bottom: 20px; padding: 15px; border-radius: 8px;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        
        <!-- Indicador de Mensagens (fora do header) -->
        {% if user.is_authenticated %}
        <div class="message-indicator-container">
            <div class="message-indicator" id="messageIndicator" onclick="toggleNotifications()">
                <span class="message-icon">üîî</span>
                <span class="message-text">
                    {% if total_notificacoes > 0 %}
                        {{ total_notificacoes }} mensagem{{ total_notificacoes|pluralize:"ns" }}
                    {% else %}
                        Sem mensagem
                    {% endif %}
                </span>
                {% if total_notificacoes > 0 %}
                    <span class="message-badge">{{ total_notificacoes }}</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Caixa de Notifica√ß√µes (oculta por padr√£o) -->
        {% if user.is_authenticated and notificacoes_globais %}
        <div class="notifications-container-base" id="notificationsContainer" style="display: none;">
            <div class="notifications-header">
                <h3 class="notifications-title">
                    <span class="notification-icon">üîî</span>
                    Novas Mensagens ({{ total_notificacoes }})
                </h3>
                <button class="close-all-notifications" onclick="marcarTodasComoLidas()" title="Marcar todas como lidas">
                    ‚úï
                </button>
            </div>
            <div class="notifications-list">
                {% for notificacao in notificacoes_globais %}
                <div class="notification-item" data-notificacao-id="{{ notificacao.id }}">
                    <div class="notification-content">
                        <div class="notification-header-item">
                            <span class="notification-type">
                                {% if notificacao.tipo_problema == 'bug' %}üêõ Bug
                                {% elif notificacao.tipo_problema == 'melhoria' %}üí° Melhoria
                                {% elif notificacao.tipo_problema == 'duvida' %}‚ùì D√∫vida
                                {% else %}üìù Outro{% endif %}
                            </span>
                            <span class="notification-date">{{ notificacao.data_atualizacao|date:"d/m/Y H:i" }}</span>
                        </div>
                        <h4 class="notification-subject">{{ notificacao.titulo }}</h4>
                        <p class="notification-message">{{ notificacao.resposta_admin|truncatewords:30 }}</p>
                    </div>
                    <button class="notification-close" onclick="marcarComoLida({{ notificacao.id }})" title="Marcar como lida">
                        ‚úï
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Conte√∫do Principal -->
        {% block content %}
        {% endblock %}
        
        <!-- Footer -->
        {% include 'questoes/footer.html' %}
    </div>
    
    <!-- JavaScript -->
    <script src="{% static 'js/quiz.js' %}"></script>
    <script>
        // Fun√ß√£o para alternar exibi√ß√£o da caixa de notifica√ß√µes
        function toggleNotifications() {
            const container = document.getElementById('notificationsContainer');
            if (container) {
                if (container.style.display === 'none' || container.style.display === '') {
                    container.style.display = 'block';
                    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    container.style.display = 'none';
                }
            }
        }
        
        // Fun√ß√µes para marcar notifica√ß√µes como lidas
        function marcarComoLida(relatorioId) {
            fetch(`/questoes/admin/relatorios/${relatorioId}/marcar-lida/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const item = document.querySelector(`[data-notificacao-id="${relatorioId}"]`);
                    if (item) {
                        item.style.opacity = '0.5';
                        setTimeout(() => item.remove(), 300);
                        
                        // Atualizar contador
                        const total = document.querySelectorAll('.notification-item').length - 1;
                        if (total === 0) {
                            document.getElementById('notificationsContainer').style.display = 'none';
                            // Recarregar p√°gina para atualizar o indicador
                            setTimeout(() => window.location.reload(), 500);
                        }
                    }
                }
            })
            .catch(error => console.error('Erro:', error));
        }
        
        function marcarTodasComoLidas() {
            fetch('/questoes/admin/relatorios/marcar-todas-lidas/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('notificationsContainer').style.display = 'none';
                    setTimeout(() => window.location.reload(), 500);
                }
            })
            .catch(error => console.error('Erro:', error));
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>

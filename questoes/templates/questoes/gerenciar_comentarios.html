{% extends 'questoes/base.html' %}
{% load static %}

{% block title %}Gerenciar Coment√°rios - Resumo Acad√™mico{% endblock %}

{% block breadcrumb %}
<!-- Breadcrumb Navigation -->
<div class="breadcrumb">
    <div class="header-container">
        <nav class="breadcrumb-nav">
            <a href="{% url 'questoes:index' %}" class="breadcrumb-link">üè† In√≠cio</a>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <a href="{% url 'questoes:admin_dashboard' %}" class="breadcrumb-link">‚öôÔ∏è Dashboard Admin</a>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <span class="breadcrumb-current">üí¨ Gerenciar Coment√°rios</span>
        </nav>
    </div>
</div>
{% endblock %}

{% block page_header %}
<!-- Page Title Section -->
<div class="page-header">
    <div class="header-container">
        <h1 class="page-title">Gerenciar Coment√°rios</h1>
        <p class="page-subtitle">Administrar coment√°rios reportados e inativos</p>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Padr√£o igual √†s outras p√°ginas */
    body {
        background-image: linear-gradient(to top, #00C6FF, #0072FF);
        min-height: 100vh;
        margin: 0;
    }
    
    .main-container {
        max-width: 1100px;
        margin: 0 auto;
        background: #FFFFFF;
        border-radius: 16px;
        border: 1px solid transparent;
        background-image: linear-gradient(#FFFFFF, #FFFFFF), linear-gradient(to top, #00C6FF, #0072FF);
        background-origin: border-box;
        background-clip: padding-box, border-box;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        padding: 0 30px 30px 30px;
        overflow: visible;
    }
    
    .content-card {
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        max-width: 100%;
        margin: 0;
        overflow: visible;
        padding: 30px 0;
    }
    
    .card-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
        padding-bottom: 16px;
        border-bottom: 2px solid #0072FF;
    }
    
    .modern-table { 
        width: 100%; 
        border-collapse: collapse; 
        background: #fff; 
        border-radius: 12px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        table-layout: auto;
    }
    .modern-table th { 
        background: linear-gradient(135deg, #0072FF 0%, #00C6FF 100%); 
        color: #fff; 
        padding: 16px; 
        text-align: left; 
        font-weight: 700; 
        font-size: 14px; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
    }
    .modern-table td { 
        padding: 16px; 
        border-bottom: 1px solid #f0f2f5; 
        vertical-align: top; 
    }
    .modern-table tr:hover { 
        background: #f8f9fa; 
    }
    .modern-table tr:last-child td { 
        border-bottom: none; 
    }
    
    .badge { 
        display: inline-block; 
        padding: 4px 8px; 
        border-radius: 6px; 
        font-size: 12px; 
        font-weight: 600; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
    }
    .badge-success { 
        background: #d4edda; 
        color: #155724; 
    }
    .badge-danger { 
        background: #f8d7da; 
        color: #721c24; 
    }
    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }
    .badge-info {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .btn-sm { 
        padding: 6px 12px; 
        font-size: 12px; 
    }
    
    .actions { 
        display: flex; 
        gap: 8px; 
        flex-wrap: wrap; 
    }
    
    .table-responsive { 
        width: 100%; 
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .modern-table { 
        width: 100%;
        min-width: 1200px;
    }
    
    @media (min-width: 1400px) {
        .modern-table {
            min-width: auto;
        }
    }
    
    @media (max-width: 768px) {
        .modern-table {
            font-size: 0.85rem;
        }
        .modern-table th,
        .modern-table td {
            padding: 12px 8px;
        }
        .actions {
            flex-direction: column;
        }
        .actions form {
            width: 100%;
        }
        .actions button {
            width: 100%;
        }
    }
    
    .loading { 
        text-align: center; 
        padding: 40px; 
        color: #666; 
    }
    .loading i { 
        font-size: 2rem; 
        margin-bottom: 16px; 
        color: #0072FF; 
    }
    
    .alert {
        padding: 16px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .alert-info {
        background-color: #e3f2fd;
        color: #1976d2;
        border-left: 4px solid #1976d2;
    }
    
    .alert-info i {
        font-size: 1.2rem;
    }
    
    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background: #0072FF;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
        color: white;
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-warning:hover {
        background: #e0a800;
        color: #212529;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="content-card">
        <h2 class="card-title">üìã Coment√°rios Reportados</h2>
        <p style="margin-bottom: 24px; color: #666;">Aqui voc√™ pode visualizar e gerenciar coment√°rios que foram reportados como abuso por usu√°rios.</p>

        {% if comentarios_com_denuncias %}
            <div class="table-responsive">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-hashtag"></i> ID</th>
                            <th><i class="fas fa-question-circle"></i> Quest√£o</th>
                            <th><i class="fas fa-comment"></i> Coment√°rio</th>
                            <th><i class="fas fa-user"></i> Autor</th>
                            <th><i class="fas fa-calendar"></i> Data</th>
                            <th><i class="fas fa-flag"></i> Status</th>
                            <th><i class="fas fa-exclamation-triangle"></i> Den√∫ncia</th>
                            <th><i class="fas fa-cogs"></i> A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in comentarios_com_denuncias %}
                            {% with comentario=item.comentario ultima_denuncia=item.ultima_denuncia total_denuncias=item.total_denuncias reporter_nome=item.reporter_nome %}
                            <tr>
                                <td><strong>#{{ comentario.id }}</strong></td>
                                <td>
                                    <a href="{% url 'questoes:quiz_vertical_filtros' comentario.id_questao.id_assunto.id %}?questao_inicial={{ comentario.id_questao.id }}&filtro=todas" 
                                       target="_blank" 
                                       class="btn btn-sm btn-primary">
                                        <i class="fas fa-external-link-alt"></i> Quest√£o {{ comentario.id_questao.id }}
                                    </a>
                                </td>
                                <td>
                                    <div style="max-width: 300px; word-wrap: break-word;">
                                        {% if comentario.comentario|length > 100 %}
                                            {{ comentario.comentario|truncatewords:20 }}...
                                        {% else %}
                                            {{ comentario.comentario }}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ comentario.nome_usuario|default:"An√¥nimo" }}</strong><br>
                                        <small style="color: #666;">{{ comentario.email_usuario|default:"N/A" }}</small>
                                    </div>
                                </td>
                                <td>
                                    <small>{{ comentario.data_comentario|date:"d/m/Y" }} √†s {{ comentario.data_comentario|date:"H:i" }}</small>
                                </td>
                                <td>
                                    <span class="badge {% if comentario.ativo %}badge-success{% else %}badge-danger{% endif %}">
                                        {% if comentario.ativo %}
                                            <i class="fas fa-check-circle"></i> Ativo
                                        {% else %}
                                            <i class="fas fa-ban"></i> Inativo
                                        {% endif %}
                                    </span>
                                    {% if total_denuncias > 0 %}
                                        <span class="badge badge-danger" style="margin-left:6px; margin-top: 4px; display: inline-block;">
                                            <i class="fas fa-flag"></i> Reportado
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ultima_denuncia %}
                                        <div style="max-width: 280px;">
                                            <div style="margin-bottom: 8px;">
                                                <strong style="font-size: 0.9rem;">{{ reporter_nome }}</strong><br>
                                                <small style="color: #666;">
                                                    {% if ultima_denuncia.email_usuario %}
                                                        {{ ultima_denuncia.email_usuario }}
                                                    {% else %}
                                                        IP: {{ ultima_denuncia.ip_usuario|default:"N/A" }}
                                                    {% endif %}
                                                </small>
                                            </div>
                                            <div style="margin-bottom: 8px;">
                                                <small style="color: #666;">{{ ultima_denuncia.data_denuncia|date:"d/m/Y" }} √†s {{ ultima_denuncia.data_denuncia|date:"H:i" }}</small>
                                            </div>
                                            {% if ultima_denuncia.tipo %}
                                                <div style="margin-bottom: 8px;">
                                                    <span class="badge badge-warning">
                                                        {% if ultima_denuncia.tipo == 'spam' %}
                                                            Spam
                                                        {% elif ultima_denuncia.tipo == 'inapropriado' %}
                                                            Conte√∫do Inapropriado
                                                        {% elif ultima_denuncia.tipo == 'bullying' %}
                                                            Bullying ou Ass√©dio
                                                        {% elif ultima_denuncia.tipo == 'outro' %}
                                                            Outro
                                                        {% else %}
                                                            {{ ultima_denuncia.get_tipo_display }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            {% endif %}
                                            {% if ultima_denuncia.motivo %}
                                                <div style="margin-bottom: 8px; font-size: 0.85rem; color: #555; word-wrap: break-word;">
                                                    {{ ultima_denuncia.motivo|truncatewords:15 }}
                                                </div>
                                            {% endif %}
                                            {% if total_denuncias > 1 %}
                                                <div>
                                                    <span class="badge badge-info">
                                                        <i class="fas fa-exclamation-circle"></i> {{ total_denuncias }} den√∫ncia(s)
                                                    </span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <small style="color: #999;">Sem detalhes</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="actions" style="min-width: 260px;">
                                        <form method="POST" action="{% url 'questoes:toggle_comentario' comentario.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" 
                                                    class="btn btn-sm {% if comentario.ativo %}btn-warning{% else %}btn-success{% endif %}"
                                                    onclick="return confirm('Tem certeza que deseja {% if comentario.ativo %}desativar{% else %}ativar{% endif %} este coment√°rio?');">
                                                <i class="fas {% if comentario.ativo %}fa-ban{% else %}fa-check{% endif %}"></i> 
                                                {% if comentario.ativo %}Desativar{% else %}Ativar{% endif %}
                                            </button>
                                        </form>
                                        
                                        <form method="POST" action="{% url 'questoes:deletar_comentario' comentario.id %}" 
                                              onsubmit="return confirm('ATEN√á√ÉO: Tem certeza que deseja EXCLUIR PERMANENTEMENTE este coment√°rio? Esta a√ß√£o n√£o pode ser desfeita.');"
                                              style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-sm">
                                                <i class="fas fa-trash"></i> Excluir
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Nenhum coment√°rio encontrado</strong><br>
                N√£o h√° coment√°rios reportados como abuso no momento.
            </div>
        {% endif %}
    </div>
</div>

<script>
    // Notifica√ß√µes
    function showNotification(message, type = 'info') {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `notification alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
        `;

        const icon = type === 'success' ? 'fas fa-check-circle' : 
                    type === 'error' ? 'fas fa-exclamation-triangle' : 
                    'fas fa-info-circle';

        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="${icon}" style="font-size: 1.2rem;"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: none; border: none; color: inherit; cursor: pointer; margin-left: auto;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }

    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    {% if messages %}
        {% for message in messages %}
            showNotification('{{ message }}', '{{ message.tags }}');
        {% endfor %}
    {% endif %}
</script>
{% endblock %}





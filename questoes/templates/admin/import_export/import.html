{% extends "admin/import_export/base.html" %}
{% load i18n %}
{% load admin_urls %}
{% load import_export_tags %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static "import_export/import.css" %}" />
<style>
  .add {
    background-color: #d4edda !important;
  }
  .change {
    background-color: #fff3cd !important;
  }
  .skip, .delete {
    background-color: #f8d7da !important;
  }
  
  .import-preview th {
    background: linear-gradient(135deg, #0072FF 0%, #00C6FF 100%);
    color: #fff;
    padding: 12px;
    text-align: left;
    font-weight: 600;
  }
  
  .import-preview td {
    padding: 10px 12px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .import-preview tbody tr:hover {
    opacity: 0.9;
  }
  
  .import-type {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
  }
  
  .instructions-box {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 20px;
    margin-bottom: 24px;
    border-radius: 4px;
  }
  
  .instructions-box h3 {
    margin-top: 0;
    color: #1976d2;
  }
  
  .legend-box {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 16px;
    margin: 20px 0;
    border-radius: 4px;
  }
  
  .error-box {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
    padding: 16px;
    margin: 20px 0;
    border-radius: 4px;
  }
</style>
{% endblock %}

{% block extrahead %}
{{ block.super }}
  <script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>
  {% if confirm_form %}
    {{ confirm_form.media }}
  {% else %}
    {{ form.media }}
  {% endif %}
{% endblock %}

{% block breadcrumbs_last %}
{% translate "Import" %} {{ opts.verbose_name }}
{% endblock %}

{% block content %}

<h1>üì• Importar {{ opts.verbose_name }}</h1>

{# ============================================ #}
{# ETAPA 1: SELEC√á√ÉO DO ARQUIVO E CONFIGURA√á√ïES #}
{# ============================================ #}
{% if not confirm_form and not result %}
<div class="instructions-box">
  <h3>üìã Instru√ß√µes de Importa√ß√£o</h3>
  <p style="margin-bottom: 8px;"><strong>Formato do arquivo:</strong> O arquivo deve conter as seguintes colunas:</p>
  <ul style="margin-top: 8px; margin-bottom: 12px;">
    <li><strong>id</strong> (opcional): Se preenchido, atualiza o registro existente. Se vazio, cria um novo.</li>
    <li><strong>texto</strong> (obrigat√≥rio): Texto completo da quest√£o.</li>
    <li><strong>id_assunto</strong> (obrigat√≥rio): ID do assunto existente no banco de dados (Foreign Key).</li>
    <li><strong>explicacao</strong> (opcional): Texto da explica√ß√£o ou justificativa da quest√£o.</li>
  </ul>
  <p style="margin-top: 12px; margin-bottom: 0;"><strong>‚ö†Ô∏è Importante:</strong> O campo <code>id_assunto</code> deve corresponder ao ID de um Assunto que j√° existe no banco de dados. Caso contr√°rio, a importa√ß√£o falhar√° para essa linha.</p>
  <p style="margin-top: 8px; margin-bottom: 0;"><strong>üìù Formatos suportados:</strong> CSV, XLSX, JSON, TSV. O CSV √© o mais recomendado para garantir compatibilidade.</p>
  <p style="margin-top: 8px; margin-bottom: 0;"><strong>üåê Codifica√ß√£o:</strong> Recomenda-se usar UTF-8 para garantir que acentos e caracteres especiais sejam importados corretamente.</p>
</div>
{% endif %}

{% if confirm_form %}
  {# ============================================ #}
  {# ETAPA 2: VISUALIZA√á√ÉO E VALIDA√á√ÉO #}
  {# ============================================ #}
  {% block confirm_import_form %}
  <form action="{% url opts|admin_urlname:"process_import" %}" method="POST">
    {% csrf_token %}
    {{ confirm_form.as_p }}
    
    <div class="legend-box">
      <p style="margin: 0;"><strong>üé® Legenda de cores:</strong></p>
      <ul style="margin: 8px 0 0 0;">
        <li><span style="background: #d4edda; padding: 4px 8px; border-radius: 3px; font-weight: 600;">Verde</span> = Linhas que ser√£o <strong>criadas</strong> (Novo)</li>
        <li><span style="background: #fff3cd; padding: 4px 8px; border-radius: 3px; font-weight: 600;">Amarelo</span> = Linhas que ser√£o <strong>atualizadas</strong> (Update)</li>
        <li><span style="background: #f8d7da; padding: 4px 8px; border-radius: 3px; font-weight: 600;">Vermelho</span> = Linhas com <strong>erros</strong> (ser√£o ignoradas)</li>
      </ul>
    </div>
    
    <p style="margin: 20px 0;">
      <strong>Revise as altera√ß√µes abaixo.</strong> Linhas em <span style="background: #d4edda; padding: 2px 6px; border-radius: 3px;">verde</span> ser√£o criadas. Linhas em <span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px;">amarelo</span> ser√£o atualizadas. Linhas em <span style="background: #f8d7da; padding: 2px 6px; border-radius: 3px;">vermelho</span> cont√™m erros e ser√£o ignoradas.
    </p>
    
    <div class="submit-row">
      <input type="submit" class="default" name="confirm" value="{% translate 'Confirmar Importa√ß√£o' %}" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
      <a href="{% url opts|admin_urlname:"changelist" %}" class="button" style="padding: 10px 20px; text-decoration: none; border-radius: 4px; background: #6c757d; color: white; display: inline-block; margin-left: 10px;">Cancelar Importa√ß√£o</a>
    </div>
  </form>
  {% endblock %}
{% else %}
  {# ============================================ #}
  {# ETAPA 1: FORMUL√ÅRIO DE UPLOAD #}
  {# ============================================ #}
  {% block import_form %}
  <form action="" method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% include "admin/import_export/resource_fields_list.html" with import_or_export="import" %}
    
    {% block form_detail %}
    <fieldset class="module aligned">
      {% for field in form %}
        <div class="form-row">
          {{ field.errors }}

          {{ field.label_tag }}

          {% if field.field.widget.attrs.readonly %}
            {{ field.field.value }}
            {{ field.as_hidden }}
          {% else %}
            {{ field }}
          {% endif %}

          {% if field.field.help_text %}
          <p class="help">{{ field.field.help_text|safe }}</p>
          {% endif %}
        </div>
      {% endfor %}
    </fieldset>
    {% endblock %}

    {% block form_submit_button %}
    <div class="submit-row">
      <input type="submit" class="default" value="{% translate 'Pr√≥ximo Passo: Visualizar Importa√ß√£o' %}" style="background: #0072FF; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
    </div>
    {% endblock %}
  </form>
  {% endblock %}
{% endif %}

{# ============================================ #}
{# RESULTADO: PR√âVIA E ERROS #}
{# ============================================ #}
{% if result %}

  {% if result.has_errors %}
  {% block errors %}
    <div class="error-box">
      <h2 style="margin-top: 0; color: #721c24;">‚ùå Erros Encontrados</h2>
      <ul>
        {% for error in result.base_errors  %}
        <li style="margin-bottom: 10px;">
          <strong>{{ error.error }}</strong>
          <div class="traceback" style="margin-top: 5px; padding: 10px; background: #fff; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">{{ error.traceback|linebreaks }}</div>
        </li>
        {% endfor %}
        {% block import_error_list %}
        {% for line, errors in result.row_errors %}
          {% for error in errors %}
            {% block import_error_list_item %}
            <li class="import-error-li" style="margin-bottom: 15px; padding: 10px; background: #fff; border-radius: 4px;">
              <div style="font-weight: 600; color: #dc3545;">{% translate "Linha" %} {{ line }} - {{ error.error }}</div>
              {% if error.row.values %}
                <div style="margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">{{ error.row.values|join:", " }}</div>
              {% endif %}
              {% if error.traceback %}
              <div class="traceback" style="margin-top: 5px; padding: 10px; background: #fff; border-radius: 4px; font-family: monospace; font-size: 0.85rem;">{{ error.traceback|linebreaks }}</div>
              {% endif %}
            </li>
            {% endblock %}
          {% endfor %}
        {% endfor %}
        {% endblock %}
      </ul>
    </div>
  {% endblock %}

  {% elif result.has_validation_errors %}

  {% block validation_errors %}
    <div class="error-box">
      <h2 style="margin-top: 0; color: #721c24;">‚ö†Ô∏è Alguns erros foram encontrados durante a valida√ß√£o</h2>
      <p style="margin-bottom: 16px;">Por favor, revise os erros abaixo e corriga-os antes de confirmar a importa√ß√£o.</p>
    </div>

    <table class="import-preview" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
      <thead>
        <tr>
          <th>{% translate "Linha" %}</th>
          <th style="background: #dc3545;">{% translate "Erros" %}</th>
          {% for field in result.diff_headers %}
            <th>{{ field }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
      {% for row in result.invalid_rows %}
        <tr style="background: #f8d7da;">
          <td style="font-weight: 600;">{{ row.number }}</td>
          <td class="errors" style="color: #721c24;">
            <span class="validation-error-count" style="font-weight: 600;">{{ row.error_count }} erro(s)</span>
            <div class="validation-error-container" style="margin-top: 8px;">
              <ul class="validation-error-list" style="margin: 0; padding-left: 20px;">
                {% for field_name, error_list in row.field_specific_errors.items %}
                  <li style="margin-bottom: 5px;">
                    <span class="validation-error-field-label" style="font-weight: 600;">{{ field_name }}:</span>
                    <ul style="margin-top: 3px;">
                      {% for error in error_list %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    </ul>
                  </li>
                {% endfor %}
                {% if row.non_field_specific_errors %}
                  <li style="margin-bottom: 5px;">
                    <span class="validation-error-field-label" style="font-weight: 600;">{% translate "Erros gerais" %}:</span>
                    <ul style="margin-top: 3px;">
                      {% for error in row.non_field_specific_errors %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    </ul>
                  </li>
                {% endif %}
              </ul>
            </div>
          </td>
          {% for field in row.values %}
            <td>{{ field }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
    {% endblock %}

  {% else %}

    {# ============================================ #}
    {# PR√âVIA V√ÅLIDA (SEM ERROS) #}
    {# ============================================ #}
    {% block preview %}
    <h2>üìä Pr√©via da Importa√ß√£o</h2>

    {% if result.valid_rows|length == 0 %}
      <div class="instructions-box">
        <p><strong>Nenhuma linha v√°lida encontrada para importa√ß√£o.</strong></p>
      </div>
    {% else %}
      <p style="margin-bottom: 16px;">Abaixo est√° uma pr√©via das <strong>primeiras 20 linhas</strong> do arquivo a serem importadas:</p>
      
      <table class="import-preview" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="width: 100px;">A√ß√£o</th>
            {% for field in result.diff_headers %}
              <th>{{ field }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
        {% for row in result.valid_rows %}
          <tr class="{{ row.import_type }}">
            <td class="import-type">
              {% if row.import_type == 'new' %}
                <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 3px; font-size: 0.75rem;">CRIAR</span>
              {% elif row.import_type == 'skip' %}
                <span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 3px; font-size: 0.75rem;">PULAR</span>
              {% elif row.import_type == 'delete' %}
                <span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 3px; font-size: 0.75rem;">EXCLUIR</span>
              {% elif row.import_type == 'update' %}
                <span style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 3px; font-size: 0.75rem; font-weight: 600;">ATUALIZAR</span>
              {% endif %}
            </td>
            {% for field in row.diff %}
              <td>{{ field }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
        </tbody>
      </table>
      
      {% if result.valid_rows|length >= 20 %}
        <p style="margin-top: 12px; color: #666; font-style: italic;">Mostrando apenas as primeiras 20 linhas. Todas as linhas v√°lidas ser√£o importadas.</p>
      {% endif %}
    {% endif %}
    {% endblock %}

  {% endif %}

{% endif %}

{% endblock %}
